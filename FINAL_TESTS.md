# üß™ Tests finaux - Validation compl√®te de l'API Mathia

Ce guide teste tous les endpoints demand√©s pour valider que le backend est totalement fonctionnel.

## üöÄ Pr√©paration

### 1. D√©marrer le serveur

```bash
npm run dev
```

**Attendez de voir** :
```
‚úÖ Connexion √† PostgreSQL √©tablie avec succ√®s
‚úÖ Mod√®les synchronis√©s avec la base de donn√©es
üöÄ Serveur Mathia d√©marr√© avec succ√®s
üìç URL: http://localhost:3000
```

### 2. Ouvrir un nouveau terminal

Tous les tests ci-dessous se font dans un nouveau terminal pendant que le serveur tourne.

---

## üìù Tests des endpoints

### ‚úÖ TEST 1 : POST /auth/signup ‚Üí Cr√©er un compte

```bash
curl -X POST http://localhost:3000/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Marie Dupont",
    "email": "marie@example.com",
    "password": "password123"
  }'
```

**üì• R√©ponse attendue :**
```json
{
  "success": true,
  "message": "Inscription r√©ussie",
  "data": {
    "user": {
      "id": 1,
      "name": "Marie Dupont",
      "email": "marie@example.com",
      "createdAt": "2025-01-15T14:30:00.000Z",
      "updatedAt": "2025-01-15T14:30:00.000Z"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjEsImlhdCI6MTcwNTMzMDAwMCwiZXhwIjoxNzA1OTM0ODAwfQ.signature_here"
  }
}
```

**‚úÖ V√©rifications :**
- Code HTTP : **201 Created**
- Token JWT pr√©sent (3 parties s√©par√©es par des points)
- password_hash **non visible** dans la r√©ponse
- ID utilisateur g√©n√©r√© automatiquement

**üîë IMPORTANT : Copiez le token !**

---

### ‚úÖ TEST 2 : POST /auth/login ‚Üí Obtenir un JWT

```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "marie@example.com",
    "password": "password123"
  }'
```

**üì• R√©ponse attendue :**
```json
{
  "success": true,
  "message": "Connexion r√©ussie",
  "data": {
    "user": {
      "id": 1,
      "name": "Marie Dupont",
      "email": "marie@example.com",
      "createdAt": "2025-01-15T14:30:00.000Z",
      "updatedAt": "2025-01-15T14:30:00.000Z"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

**‚úÖ V√©rifications :**
- Code HTTP : **200 OK**
- M√™me utilisateur que signup
- Nouveau token g√©n√©r√©
- Mauvais password ‚Üí **401 Unauthorized**

**üíæ Sauvegarder le token dans une variable :**

```bash
# Linux/Mac/Git Bash
export TOKEN="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# Windows PowerShell
$env:TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."

# Windows CMD
set TOKEN=eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

---

### ‚úÖ TEST 3 : GET /courses ‚Üí R√©cup√©rer les cours

```bash
curl http://localhost:3000/api/courses \
  -H "Authorization: Bearer $TOKEN"
```

**üì• R√©ponse attendue :**
```json
{
  "success": true,
  "data": {
    "courses": [
      {
        "id": 3,
        "title": "Les √©quations",
        "grade": "3√®me",
        "chapter": "Alg√®bre",
        "description": "R√©soudre des √©quations du premier degr√©",
        "createdAt": "2025-01-15T10:02:00.000Z",
        "updatedAt": "2025-01-15T10:02:00.000Z",
        "exercises": []
      },
      {
        "id": 2,
        "title": "G√©om√©trie de base",
        "grade": "6√®me",
        "chapter": "G√©om√©trie",
        "description": "Les formes g√©om√©triques",
        "createdAt": "2025-01-15T10:01:00.000Z",
        "updatedAt": "2025-01-15T10:01:00.000Z",
        "exercises": []
      },
      {
        "id": 1,
        "title": "Les fractions",
        "grade": "6√®me",
        "chapter": "Arithm√©tique",
        "description": "Apprendre les fractions simples",
        "createdAt": "2025-01-15T10:00:00.000Z",
        "updatedAt": "2025-01-15T10:00:00.000Z",
        "exercises": [
          {
            "id": 1,
            "type": "qcm",
            "difficulty": "facile"
          }
        ]
      }
    ]
  }
}
```

**‚úÖ V√©rifications :**
- Code HTTP : **200 OK**
- Tableau de cours (peut √™tre vide si pas de donn√©es)
- Chaque cours a : id, title, grade, chapter, description
- Exercices associ√©s (tableau peut √™tre vide)
- Ordre d√©croissant (plus r√©cents d'abord)
- **Sans token** ‚Üí **401 Unauthorized**

---

### ‚úÖ TEST 4 : GET /exercises?courseId=1&difficulty=facile ‚Üí Filtrer les exercices

**Test 4a : Tous les exercices (sans filtre)**

```bash
curl http://localhost:3000/api/exercises \
  -H "Authorization: Bearer $TOKEN"
```

**Test 4b : Filtre par courseId**

```bash
curl "http://localhost:3000/api/exercises?courseId=1" \
  -H "Authorization: Bearer $TOKEN"
```

**Test 4c : Filtre par difficulty**

```bash
curl "http://localhost:3000/api/exercises?difficulty=facile" \
  -H "Authorization: Bearer $TOKEN"
```

**Test 4d : Les deux filtres combin√©s**

```bash
curl "http://localhost:3000/api/exercises?courseId=1&difficulty=facile" \
  -H "Authorization: Bearer $TOKEN"
```

**üì• R√©ponse attendue :**
```json
{
  "success": true,
  "data": {
    "exercises": [
      {
        "id": 1,
        "courseId": 1,
        "type": "qcm",
        "body": "Quelle est la moiti√© de 10?",
        "options": {
          "A": "3",
          "B": "5",
          "C": "7",
          "D": "10"
        },
        "answer": "B",
        "explanation": "10 divis√© par 2 √©gale 5",
        "difficulty": "facile",
        "tags": ["fractions", "division"],
        "createdAt": "2025-01-15T10:15:00.000Z",
        "updatedAt": "2025-01-15T10:15:00.000Z",
        "course": {
          "id": 1,
          "title": "Les fractions",
          "grade": "6√®me",
          "chapter": "Arithm√©tique"
        }
      }
    ]
  }
}
```

**‚úÖ V√©rifications :**
- Code HTTP : **200 OK**
- Filtrage par `courseId` fonctionne
- Filtrage par `difficulty` fonctionne
- Les deux filtres peuvent √™tre combin√©s
- Chaque exercice inclut les infos du cours
- Tableau vide `[]` si aucun r√©sultat

---

### ‚úÖ TEST 5 : POST /attempts ‚Üí Enregistrer une r√©ponse

**Test 5a : R√©ponse correcte**

```bash
curl -X POST http://localhost:3000/api/attempts \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "exerciseId": 1,
    "userAnswer": "B"
  }'
```

**üì• R√©ponse attendue (correcte) :**
```json
{
  "success": true,
  "data": {
    "attempt": {
      "id": 1,
      "exerciseId": 1,
      "userAnswer": "B",
      "isCorrect": true,
      "createdAt": "2025-01-15T12:30:00.000Z"
    },
    "isCorrect": true,
    "explanation": "10 divis√© par 2 √©gale 5",
    "correctAnswer": "B"
  }
}
```

**Test 5b : R√©ponse incorrecte**

```bash
curl -X POST http://localhost:3000/api/attempts \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "exerciseId": 1,
    "userAnswer": "A"
  }'
```

**üì• R√©ponse attendue (incorrecte) :**
```json
{
  "success": true,
  "data": {
    "attempt": {
      "id": 2,
      "exerciseId": 1,
      "userAnswer": "A",
      "isCorrect": false,
      "createdAt": "2025-01-15T12:31:00.000Z"
    },
    "isCorrect": false
  }
}
```

**‚úÖ V√©rifications :**
- Code HTTP : **201 Created**
- `isCorrect` calcul√© automatiquement
- Si **correct** : `explanation` et `correctAnswer` pr√©sents
- Si **incorrect** : pas d'explication (pour ne pas donner la r√©ponse)
- Comparaison insensible √† la casse (trim + lowercase)
- Tentative enregistr√©e en base de donn√©es

**üîç V√©rifier en base :**
```sql
SELECT * FROM attempts ORDER BY "createdAt" DESC LIMIT 5;
```

---

## ‚úÖ TEST BONUS : Protection JWT

### Test sans token (doit √©chouer)

```bash
curl http://localhost:3000/api/courses
```

**üì• R√©ponse attendue :**
```json
{
  "success": false,
  "message": "Acc√®s non autoris√©. Token manquant."
}
```

**Code HTTP : 401 Unauthorized** ‚úÖ

### Test avec mauvais token (doit √©chouer)

```bash
curl http://localhost:3000/api/courses \
  -H "Authorization: Bearer invalid_token_here"
```

**üì• R√©ponse attendue :**
```json
{
  "success": false,
  "message": "Token invalide."
}
```

**Code HTTP : 401 Unauthorized** ‚úÖ

---

## üìä R√©capitulatif des tests

| Endpoint | M√©thode | JWT | Test | R√©sultat attendu |
|----------|---------|-----|------|------------------|
| `/auth/signup` | POST | ‚ùå Non | Cr√©er compte | 201 + token |
| `/auth/login` | POST | ‚ùå Non | Se connecter | 200 + token |
| `/courses` | GET | ‚úÖ Oui | Liste cours | 200 + tableau |
| `/exercises` | GET | ‚úÖ Oui | Liste exercices | 200 + tableau |
| `/exercises?courseId=1&difficulty=facile` | GET | ‚úÖ Oui | Filtre exercices | 200 + filtr√© |
| `/attempts` | POST | ‚úÖ Oui | Soumettre r√©ponse | 201 + isCorrect |
| `/courses` sans JWT | GET | ‚ùå Non | Test s√©curit√© | 401 |

## ‚úÖ Checklist finale

V√©rifier que **TOUS** ces points sont valid√©s :

### Configuration
- [ ] Serveur d√©marr√© sur port 3000
- [ ] PostgreSQL connect√©
- [ ] Tables cr√©√©es (users, courses, exercises, attempts)
- [ ] Fichier .env configur√©

### Endpoints publics (sans JWT)
- [ ] POST /auth/signup ‚Üí 201 Created
- [ ] POST /auth/login ‚Üí 200 OK
- [ ] Token JWT retourn√© dans les deux cas
- [ ] Password hash√© (bcrypt, commence par $2)

### Endpoints prot√©g√©s (avec JWT)
- [ ] GET /courses ‚Üí 200 OK
- [ ] GET /courses/:id ‚Üí 200 OK
- [ ] GET /exercises ‚Üí 200 OK
- [ ] GET /exercises?courseId=1 ‚Üí 200 OK avec filtre
- [ ] GET /exercises?difficulty=facile ‚Üí 200 OK avec filtre
- [ ] GET /exercises?courseId=1&difficulty=facile ‚Üí 200 OK avec les deux filtres
- [ ] POST /attempts ‚Üí 201 Created
- [ ] POST /admin/exercises ‚Üí 201 Created

### S√©curit√©
- [ ] Routes prot√©g√©es sans JWT ‚Üí 401
- [ ] Mauvais token ‚Üí 401
- [ ] Token expir√© ‚Üí 401
- [ ] Validation Joi fonctionne (email invalide ‚Üí 400)

### V√©rification des donn√©es
- [ ] isCorrect calcul√© correctement (B == B ‚Üí true, A == B ‚Üí false)
- [ ] Explication retourn√©e si r√©ponse correcte
- [ ] Explication cach√©e si r√©ponse incorrecte
- [ ] Tentatives enregistr√©es en base

---

## üéØ Script de test complet (copier-coller)

```bash
#!/bin/bash

echo "üß™ Tests de l'API Mathia"
echo ""

# 1. Signup
echo "1Ô∏è‚É£ POST /auth/signup"
SIGNUP=$(curl -s -X POST http://localhost:3000/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{"name":"Test User","email":"test_final@example.com","password":"test123"}')

echo "$SIGNUP" | jq '.'
TOKEN=$(echo "$SIGNUP" | jq -r '.data.token')
echo "‚úÖ Token: ${TOKEN:0:30}..."
echo ""
sleep 1

# 2. Login
echo "2Ô∏è‚É£ POST /auth/login"
curl -s -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"test_final@example.com","password":"test123"}' | jq '.'
echo ""
sleep 1

# 3. Courses
echo "3Ô∏è‚É£ GET /courses"
curl -s http://localhost:3000/api/courses \
  -H "Authorization: Bearer $TOKEN" | jq '.'
echo ""
sleep 1

# 4. Exercises sans filtre
echo "4Ô∏è‚É£ GET /exercises (sans filtre)"
curl -s http://localhost:3000/api/exercises \
  -H "Authorization: Bearer $TOKEN" | jq '.data.exercises | length' 
echo "exercices trouv√©s"
echo ""
sleep 1

# 5. Exercises avec filtres
echo "5Ô∏è‚É£ GET /exercises?courseId=1&difficulty=facile"
curl -s "http://localhost:3000/api/exercises?courseId=1&difficulty=facile" \
  -H "Authorization: Bearer $TOKEN" | jq '.'
echo ""
sleep 1

# 6. Attempts
echo "6Ô∏è‚É£ POST /attempts (r√©ponse test)"
curl -s -X POST http://localhost:3000/api/attempts \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"exerciseId":1,"userAnswer":"B"}' | jq '.'
echo ""

echo "‚úÖ Tous les tests termin√©s!"
```

**Sauvegarder dans un fichier** :
```bash
cat > test_all.sh << 'EOF'
[copier le script ci-dessus]
EOF

chmod +x test_all.sh
./test_all.sh
```

---

## üîç V√©rification en base de donn√©es

```sql
-- Se connecter
psql -U postgres -d mathia

-- V√©rifier l'utilisateur cr√©√©
SELECT id, name, email, LEFT(password_hash, 10) as hash_preview 
FROM users 
WHERE email = 'marie@example.com';

-- Le password_hash doit commencer par $2a$ ou $2b$
-- Exemple: $2a$10$abcd...

-- V√©rifier les tentatives
SELECT 
  u.name,
  e.body,
  a."userAnswer",
  a."isCorrect",
  a."createdAt"
FROM attempts a
JOIN users u ON a."userId" = u.id
JOIN exercises e ON a."exerciseId" = e.id
WHERE u.email = 'marie@example.com'
ORDER BY a."createdAt" DESC;
```

---

## üì± Test avec l'app iOS

### 1. Ouvrir l'app dans Xcode

```bash
cd mobile/MathiaApp
# Ouvrir le fichier .xcodeproj dans Xcode
```

### 2. Configurer l'URL

Dans `Services/APIService.swift` :
```swift
private let baseURL = "http://localhost:3000/api"
```

### 3. Lancer l'app (‚åò+R)

### 4. Tester le flux complet

1. **Inscription** : Remplir le formulaire
   - Nom : "Test iOS"
   - Email : "ios@test.com"
   - Password : "test123"
   - Confirmer : "test123"

2. **Connexion automatique** apr√®s inscription

3. **Liste des cours** : Doit afficher les 3 cours cr√©√©s

4. **Ouvrir un cours** : Cliquer sur "Les fractions"

5. **Liste des exercices** : Voir l'exercice cr√©√©

6. **R√©soudre l'exercice** : 
   - Lire la question
   - S√©lectionner "B"
   - Cliquer sur "Valider"

7. **Voir le r√©sultat** :
   - Carte verte avec ‚úÖ
   - Explication affich√©e
   - Message "Bonne r√©ponse !"

---

## üéâ Validation finale

Si tous ces tests passent, le backend est **totalement fonctionnel** et pr√™t pour :

‚úÖ **Production** (avec configuration HTTPS)  
‚úÖ **App iOS** (connexion test√©e et valid√©e)  
‚úÖ **D√©veloppement** (environnement complet)  
‚úÖ **Tests automatis√©s**  
‚úÖ **G√©n√©ration IA d'exercices**  
‚úÖ **Documentation compl√®te**  

---

## üöÄ Commandes ultra-rapides

```bash
# Test complet en une commande
npm run test:api

# Ou manuellement (apr√®s avoir cr√©√© un compte)
export TOKEN="votre_token"
curl http://localhost:3000/api/courses -H "Authorization: Bearer $TOKEN"
curl "http://localhost:3000/api/exercises?courseId=1&difficulty=facile" -H "Authorization: Bearer $TOKEN"
curl -X POST http://localhost:3000/api/attempts -H "Authorization: Bearer $TOKEN" -H "Content-Type: application/json" -d '{"exerciseId":1,"userAnswer":"B"}'
```

---

üéì **Le backend Mathia est 100% fonctionnel et pr√™t pour l'app iOS !**





