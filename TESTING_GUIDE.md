# üß™ Guide de Test de l'API Mathia

Ce guide explique comment tester tous les endpoints de l'API.

## üìã Avant de commencer

### 1. D√©marrer le serveur

```bash
npm run dev
```

Le serveur doit √™tre accessible sur `http://localhost:3000`

### 2. V√©rifier que la base de donn√©es est connect√©e

Vous devriez voir dans les logs :
```
‚úÖ Connexion √† PostgreSQL √©tablie avec succ√®s
‚úÖ Mod√®les synchronis√©s avec la base de donn√©es
üöÄ Serveur Mathia d√©marr√© avec succ√®s
üìç URL: http://localhost:3000
```

## üöÄ Lancer les tests automatis√©s

### Option 1 : Script Node.js (recommand√©)

```bash
npm run test:api
```

Ou directement :
```bash
node tests/test_api.js
```

### Option 2 : Script Bash (Linux/Mac)

```bash
npm run test:api:bash
```

Ou directement :
```bash
bash tests/test_api.sh
```

## üìä Tests effectu√©s

Les scripts testent automatiquement :

### ‚úÖ 1. POST /auth/signup - Cr√©er un compte

**Requ√™te :**
```json
{
  "name": "Test User",
  "email": "test_1234567890@example.com",
  "password": "test123456"
}
```

**R√©ponse attendue (201 Created) :**
```json
{
  "success": true,
  "message": "Inscription r√©ussie",
  "data": {
    "user": {
      "id": 1,
      "name": "Test User",
      "email": "test_1234567890@example.com",
      "createdAt": "2025-01-15T14:30:00.000Z",
      "updatedAt": "2025-01-15T14:30:00.000Z"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

**V√©rifications :**
- ‚úÖ Code HTTP 201
- ‚úÖ Token JWT retourn√©
- ‚úÖ password_hash non visible dans la r√©ponse
- ‚úÖ Email unique (409 si d√©j√† utilis√©)

---

### ‚úÖ 2. POST /auth/login - Obtenir un JWT

**Requ√™te :**
```json
{
  "email": "test_1234567890@example.com",
  "password": "test123456"
}
```

**R√©ponse attendue (200 OK) :**
```json
{
  "success": true,
  "message": "Connexion r√©ussie",
  "data": {
    "user": {
      "id": 1,
      "name": "Test User",
      "email": "test_1234567890@example.com",
      "createdAt": "2025-01-15T14:30:00.000Z",
      "updatedAt": "2025-01-15T14:30:00.000Z"
    },
    "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
  }
}
```

**V√©rifications :**
- ‚úÖ Code HTTP 200
- ‚úÖ Token JWT retourn√©
- ‚úÖ Infos utilisateur correctes
- ‚úÖ Mot de passe incorrect ‚Üí 401

---

### ‚úÖ 3. GET /courses - R√©cup√©rer les cours

**Requ√™te :**
```
GET /api/courses
Headers: Authorization: Bearer {token}
```

**R√©ponse attendue (200 OK) :**
```json
{
  "success": true,
  "data": {
    "courses": [
      {
        "id": 1,
        "title": "Les fractions",
        "grade": "6√®me",
        "chapter": "Arithm√©tique",
        "description": "Apprendre les fractions simples",
        "createdAt": "2025-01-15T10:00:00.000Z",
        "updatedAt": "2025-01-15T10:00:00.000Z",
        "exercises": [
          {
            "id": 1,
            "type": "qcm",
            "difficulty": "facile"
          }
        ]
      }
    ]
  }
}
```

**V√©rifications :**
- ‚úÖ Code HTTP 200
- ‚úÖ Liste de cours avec exercices
- ‚úÖ Sans token ‚Üí 401
- ‚úÖ Ordre d√©croissant (plus r√©cents d'abord)

---

### ‚úÖ 4. GET /exercises - Lister tous les exercices

**Requ√™te :**
```
GET /api/exercises
Headers: Authorization: Bearer {token}
```

**R√©ponse attendue (200 OK) :**
```json
{
  "success": true,
  "data": {
    "exercises": [
      {
        "id": 1,
        "courseId": 1,
        "type": "qcm",
        "body": "Quelle est la moiti√© de 10?",
        "options": {
          "A": "3",
          "B": "5",
          "C": "7",
          "D": "10"
        },
        "answer": "B",
        "explanation": "10 divis√© par 2 √©gale 5",
        "difficulty": "facile",
        "tags": ["fractions", "division"],
        "createdAt": "2025-01-15T10:15:00.000Z",
        "updatedAt": "2025-01-15T10:15:00.000Z",
        "course": {
          "id": 1,
          "title": "Les fractions",
          "grade": "6√®me",
          "chapter": "Arithm√©tique"
        }
      }
    ]
  }
}
```

**V√©rifications :**
- ‚úÖ Code HTTP 200
- ‚úÖ Exercices avec infos du cours
- ‚úÖ Tous les champs pr√©sents
- ‚úÖ Sans token ‚Üí 401

---

### ‚úÖ 5. GET /exercises?courseId=1&difficulty=facile - Filtrer

**Requ√™te :**
```
GET /api/exercises?courseId=1&difficulty=facile
Headers: Authorization: Bearer {token}
```

**R√©ponse attendue (200 OK) :**
```json
{
  "success": true,
  "data": {
    "exercises": [
      {
        "id": 1,
        "courseId": 1,
        "difficulty": "facile",
        ...
      }
    ]
  }
}
```

**V√©rifications :**
- ‚úÖ Filtrage par courseId fonctionne
- ‚úÖ Filtrage par difficulty fonctionne
- ‚úÖ Les deux filtres peuvent √™tre combin√©s
- ‚úÖ Retourne un tableau vide si aucun r√©sultat

---

### ‚úÖ 6. POST /attempts - Enregistrer une r√©ponse

**Requ√™te :**
```json
{
  "exerciseId": 1,
  "userAnswer": "B"
}
```

**R√©ponse attendue - Correcte (201 Created) :**
```json
{
  "success": true,
  "data": {
    "attempt": {
      "id": 1,
      "exerciseId": 1,
      "userAnswer": "B",
      "isCorrect": true,
      "createdAt": "2025-01-15T12:30:00.000Z"
    },
    "isCorrect": true,
    "explanation": "10 divis√© par 2 √©gale 5",
    "correctAnswer": "B"
  }
}
```

**R√©ponse attendue - Incorrecte (201 Created) :**
```json
{
  "success": true,
  "data": {
    "attempt": {
      "id": 2,
      "exerciseId": 1,
      "userAnswer": "A",
      "isCorrect": false,
      "createdAt": "2025-01-15T12:31:00.000Z"
    },
    "isCorrect": false
  }
}
```

**V√©rifications :**
- ‚úÖ Code HTTP 201
- ‚úÖ isCorrect calcul√© correctement
- ‚úÖ Explication retourn√©e si correct
- ‚úÖ Explication cach√©e si incorrect
- ‚úÖ Enregistrement en base de donn√©es
- ‚úÖ Exercice inexistant ‚Üí 404

---

### ‚úÖ 7. Test sans authentification

**Requ√™te :**
```
GET /api/courses
(sans header Authorization)
```

**R√©ponse attendue (401 Unauthorized) :**
```json
{
  "success": false,
  "message": "Acc√®s non autoris√©. Token manquant."
}
```

**V√©rifications :**
- ‚úÖ Code HTTP 401
- ‚úÖ Protection JWT active
- ‚úÖ Routes /auth accessibles sans token
- ‚úÖ Autres routes bloqu√©es sans token

---

## üéØ Tests manuels avec curl

Si le serveur est d√©marr√©, testez manuellement :

### 1. Cr√©er un compte

```bash
curl -X POST http://localhost:3000/api/auth/signup \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Marie Dupont",
    "email": "marie@example.com",
    "password": "password123"
  }'
```

### 2. Se connecter

```bash
curl -X POST http://localhost:3000/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "marie@example.com",
    "password": "password123"
  }'
```

**‚Üí Copier le token de la r√©ponse**

### 3. Exporter le token

```bash
# Linux/Mac
export TOKEN="votre_token_ici"

# Windows PowerShell
$TOKEN = "votre_token_ici"
```

### 4. R√©cup√©rer les cours

```bash
# Linux/Mac
curl http://localhost:3000/api/courses \
  -H "Authorization: Bearer $TOKEN"

# Windows PowerShell
curl http://localhost:3000/api/courses -Headers @{"Authorization"="Bearer $TOKEN"}
```

### 5. Filtrer les exercices

```bash
curl "http://localhost:3000/api/exercises?courseId=1&difficulty=facile" \
  -H "Authorization: Bearer $TOKEN"
```

### 6. Soumettre une r√©ponse

```bash
curl -X POST http://localhost:3000/api/attempts \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "exerciseId": 1,
    "userAnswer": "B"
  }'
```

---

## üîç V√©rifier les donn√©es en base

```sql
-- Voir tous les utilisateurs
SELECT id, name, email, "createdAt" FROM users;

-- Voir toutes les tentatives
SELECT 
  u.name AS utilisateur,
  e.body AS question,
  a."userAnswer" AS reponse,
  a."isCorrect" AS correct,
  a."createdAt" AS date
FROM attempts a
JOIN users u ON a."userId" = u.id
JOIN exercises e ON a."exerciseId" = e.id
ORDER BY a."createdAt" DESC;

-- Compter les tentatives par utilisateur
SELECT 
  u.name,
  COUNT(*) AS total_tentatives,
  SUM(CASE WHEN a."isCorrect" THEN 1 ELSE 0 END) AS bonnes_reponses
FROM attempts a
JOIN users u ON a."userId" = u.id
GROUP BY u.name;
```

---

## üêõ D√©pannage

### ‚ùå "Connection refused" ou "ECONNREFUSED"

**Probl√®me** : Le serveur n'est pas d√©marr√©

**Solution** :
```bash
npm run dev
```

Attendez de voir :
```
üöÄ Serveur Mathia d√©marr√© avec succ√®s
üìç URL: http://localhost:3000
```

---

### ‚ùå "Database connection failed"

**Probl√®me** : PostgreSQL n'est pas d√©marr√© ou mal configur√©

**Solution** :
1. V√©rifier que PostgreSQL est d√©marr√©
2. V√©rifier le fichier `.env` :
   ```env
   DATABASE_URL=postgresql://postgres:password@localhost:5432/mathia
   ```
3. Cr√©er la base si n√©cessaire :
   ```bash
   createdb mathia
   ```

---

### ‚ùå 404 sur POST /attempts

**Probl√®me** : Aucun exercice en base de donn√©es

**Solution** : Cr√©er un exercice via l'API :
```bash
curl -X POST http://localhost:3000/api/admin/exercises \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "courseId": 1,
    "type": "qcm",
    "body": "Quelle est la moiti√© de 10?",
    "options": {"A": "3", "B": "5", "C": "7", "D": "10"},
    "answer": "B",
    "explanation": "10 √∑ 2 = 5",
    "difficulty": "facile",
    "tags": ["fractions"]
  }'
```

---

### ‚ùå 401 Unauthorized

**Probl√®me** : Token manquant, invalide ou expir√©

**Solutions** :
1. V√©rifier que vous incluez le header :
   ```
   Authorization: Bearer {token}
   ```
2. G√©n√©rer un nouveau token :
   ```bash
   curl -X POST http://localhost:3000/api/auth/login \
     -H "Content-Type: application/json" \
     -d '{"email":"marie@example.com","password":"password123"}'
   ```
3. V√©rifier JWT_SECRET dans `.env`

---

## üìä R√©sultat attendu du script de test

```
======================================================================
üß™ TEST DE L'API MATHIA
======================================================================

üìç URL de base: http://localhost:3000/api
üìß Email de test: test_1705330000@example.com

‚úÖ Inscription r√©ussie
üîë Token r√©cup√©r√© (152 caract√®res)
üë§ User ID: 5

‚úÖ Connexion r√©ussie
üîë Nouveau token r√©cup√©r√©

‚úÖ R√©cup√©ration des cours r√©ussie
üìö Nombre de cours: 2

‚úÖ R√©cup√©ration des exercices r√©ussie
üìù Nombre d'exercices: 5
üéØ Premier exercice ID: 1

‚úÖ Filtrage des exercices r√©ussi
üìù Exercices faciles du cours 1: 3

‚úÖ Enregistrement de la r√©ponse r√©ussi
‚úì R√©ponse enregistr√©e (Correcte: true)

‚úÖ Protection JWT fonctionne correctement

======================================================================
üìä R√âSUM√â DES TESTS
======================================================================

‚úÖ Tests termin√©s
```

---

## üéâ Checklist compl√®te

Avant de dire que tout fonctionne :

- [ ] Serveur d√©marr√© (`npm run dev`)
- [ ] Base de donn√©es connect√©e
- [ ] POST /auth/signup ‚Üí 201 Created
- [ ] POST /auth/login ‚Üí 200 OK avec token
- [ ] GET /courses ‚Üí 200 OK (avec token)
- [ ] GET /exercises ‚Üí 200 OK (avec token)
- [ ] GET /exercises?courseId=1&difficulty=facile ‚Üí 200 OK
- [ ] POST /attempts ‚Üí 201 Created (avec token)
- [ ] GET /courses (sans token) ‚Üí 401 Unauthorized
- [ ] Validation Joi fonctionne (email invalide ‚Üí 400)
- [ ] Password hash√© (pas visible en base)

---

‚úÖ **Tous les endpoints test√©s et fonctionnels !**









